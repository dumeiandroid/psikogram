<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil Pemeriksaan Psikologis</title>

    <!--
    ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
    ‚ïë  LOAD ENGINE                                         ‚ïë
    ‚ïë  Offline (satu folder) : src="psikogram-engine.js"  ‚ïë
    ‚ïë  Online  (dari server) : src="https://domain.com/.. ‚ïë
    ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
    -->
    <script src="psikogram-engine.js"></script>

    <style>
        /* =============================================
           BAGIAN INI BEBAS DIMODIFIKASI
           ============================================= */
        * { box-sizing: border-box; }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #7000E0;
            background-image: url('images/bg1.jpg');
            background-size: 100% 100%;
            background-position: center;
            background-repeat: no-repeat;
            color: black;
        }

        /* --- Loading Screen --- */
        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(95,78,218,0.95);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            z-index: 9999; color: white;
        }
        .spinner {
            width: 50px; height: 50px;
            border: 5px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 16px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        #loading-screen.hidden { display: none; }

        /* --- Tombol Navigasi --- */
        .tombol-nav {
            background: #5F4EDA;
            padding: 10px 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        .tombol-nav a, .tombol-nav button {
            background: white; color: #5F4EDA;
            border: none; padding: 6px 14px;
            border-radius: 4px; cursor: pointer;
            font-size: 13px; font-weight: bold;
            text-decoration: none; display: inline-block;
        }
        .tombol-nav a:hover, .tombol-nav button:hover { background: #e0d9ff; }
        .konsistensi-info { color: white; font-weight: bold; margin-left: auto; font-size: 14px; }

        /* --- Containers --- */
        .container1 {
            background: white; width: 90%;
            height: auto;
            padding: 20px; border: none;
            box-shadow: none; margin: 0 auto;
        }
        .container_a {
            background: white; position: relative;
            width: 90%;
            height: auto;
            padding: 20px; border: none;
            box-shadow: none; margin: 0 auto;
        }
        .container_a::before {
            content: ""; position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            background-image: url('gambar/logo1.png');
            background-size: 70%; background-position: center;
            background-repeat: no-repeat; opacity: 0.1; z-index: 0;
        }
        .container_a > * { position: relative; z-index: 1; }

        /* --- Header Institusi --- */
        .custom-header {
            display: grid; grid-template-columns: auto 1fr;
            align-items: center; margin-bottom: 20px;
            background-color: #5F4EDA; padding: 10px; border-radius: 8px;
        }
        .logo-container_a { margin-right: 10px; }
        .logo { width: 130px; height: auto; }
        .info-container_a {
            text-align: center; display: flex;
            flex-direction: column; align-items: center; margin-left: -80px;
            width: 95%;
        }
        .header-title  { font-size: 24px; font-weight: bold; color: white; margin: 2px 0; }
        .header-subtitle { font-size: 18px; font-style: italic; color: #e0f7fa; margin: 2px 0; }
        .location, .address, .phone { margin: 2px 0; color: white; }
        .website { margin: 2px 0; color: #e0f7fa; }
        .website a { color: #e0f7fa; text-decoration: underline; }

        /* --- Tabel --- */
        table {
            width: 100%; border-collapse: collapse;
            border-top: 3px double black; border-bottom: 3px double black;
        }
        th, td { padding: 8px; border: 1px solid black; }
        th { text-align: center; font-size: inherit; }
        td { text-align: left; font-size: inherit; }
        .header { background-color: #f2f2f2; }
        .highlight { background-color: #d1e7dd; text-align: center; }
        .no-inner-borders td { border: none; }
        .section-header { font-weight: bold; color: white; background-color: black; text-align: center; }
        .custom-table { border-collapse: collapse; width: 100%; }
        .custom-table td { padding: 5px; }

        /* --- Halaman 2 --- */
        .strength-weakness { margin-top: 20px; }
        .custom-list { margin-left: 10px; margin-top: 5px; padding: 10px; }
        .container_a p, .container_a li { text-align: justify; font-size: inherit; line-height: 1.6; }
        .container_a .custom-list li { margin-bottom: 2px; }
        .strength-weakness strong, .strength-weakness h4 { text-align: left; display: block; }
        .signature { margin-top: 20px; text-align: right; }
        .signature p { font-size: inherit; line-height: 1.4; }
        .enter { margin: 20px 0; }

        /* --- Tombol Download --- */
        #downloadBtn {
            display: block; margin: 20px auto;
            padding: 12px 30px; background: #5F4EDA;
            color: white; border: none; border-radius: 6px;
            font-size: 16px; font-weight: bold; cursor: pointer;
        }
        #downloadBtn:hover { background: #4a3bb5; }

        @media print {
            body { background-color: white; }
            .tombol-nav, #downloadBtn { display: none; }
        }
        .container1, .container_a {
            font-size: 120%;
        }

        .batas-download {
            display: block;
        }

        #downloadContent1, #downloadContent2 {
            height: auto;
        }
    </style>
</head>
<body>

<!-- Loading Screen -->
<div id="loading-screen">
    <div class="spinner"></div>
    <p style="font-size:18px; font-weight:bold;">Memuat data psikogram...</p>
</div>

<!-- Tombol Navigasi -->
<div class="tombol-nav no-download">
    <button onclick="window.history.back()">‚Üê Kembali</button>
    <button onclick="window.print()">üñ®Ô∏è Print</button>
    <button id="downloadBtn2">üì• Download PDF</button>
    <span class="konsistensi-info" id="konsistensi-display">Konsistensi = -</span>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     HALAMAN 1 ‚Äî Tabel Aspek Psikologis
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="batas-download" id="downloadContent1">
    <div class="container1">

        <!-- Header Institusi -->
        <div class="custom-header no-download">
            <div class="logo-container_a">
                <img src="gambar/logo1.png" alt="Logo" class="logo"/>
            </div>
            <div class="info-container_a">
                <div class="header-title">PT. LIDAN INDAH ABADI</div>
                <div class="header-subtitle">LIDAN PSIKOLOGI</div>
                <div class="location">Regus Forum Nine, Lantai 9 CIMB NIAGA PLAZA</div>
                <div class="address">Jalan Imam Bonjol No.9, Medan 20159, Sumatera Utara</div>
                <div class="phone">Telepon: +62851-5960-1400</div>
                <div class="website">
                    Website: <a href="http://www.lidan.co.id">www.lidan.co.id</a>,
                    Email: <a href="/cdn-cgi/l/email-protection#bcdfcffcd0d5d8ddd292dfd392d5d8"><span class="__cf_email__" data-cfemail="573424173b3e333639793438793e33">[email&#160;protected]</span></a>
                </div>
            </div>
        </div>

        <!-- Identitas Peserta -->
        <h2 style="text-align:center;">PROFIL PEMERIKSAAN PSIKOLOGIS</h2>
        <table class="no-inner-borders custom-table">
            <tr>
                <td style="width:200px; border-left:none;">Nama</td>
                <td style="width:20px;">:</td>
                <td style="border-right:none;" id="td-nama"></td>
            </tr>
            <tr>
                <td style="border-left:none;">Jenis Kelamin</td>
                <td>:</td>
                <td style="border-right:none;" id="td-jk"></td>
            </tr>
            <tr>
                <td style="border-left:none;">Usia</td>
                <td>:</td>
                <td style="border-right:none;"><span id="td-usia"></span> Tahun</td>
            </tr>
            <tr>
                <td style="border-left:none;">Tanggal Pemeriksaan</td>
                <td>:</td>
                <td style="border-right:none;" id="td-tanggal"></td>
            </tr>
        </table>

        <!-- Tabel Aspek Psikologis -->
        <h3 style="text-align:center;">Aspek Psikologis</h3>
        <table>
            <thead>
                <tr class="header">
                    <th rowspan="2" style="width:250px; vertical-align:middle;">Aspek Psikologis</th>
                    <th rowspan="2" style="width:600px; vertical-align:middle;">Keterangan</th>
                    <th colspan="10">Skala</th>
                </tr>
                <tr class="header">
                    <th colspan="4">K</th>
                    <th colspan="2">C</th>
                    <th colspan="2">B</th>
                    <th colspan="2">BS</th>
                </tr>
            </thead>
            <tbody id="tbody-aspek">
                <!-- Diisi otomatis oleh JavaScript -->
            </tbody>
        </table>
        <br>
        *Keterangan : K = Kurang ; C = Cukup ; B = Baik ; BS = Baik Sekali
        <div class="enter"></div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     HALAMAN 2 ‚Äî Narasi & Tanda Tangan
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="batas-download" id="downloadContent2">
    <div class="container_a">
        <div class="strength-weakness">

            <div><strong>Intelligence Quotient (IQ) :</strong></div>
            <ul class="custom-list">
                <li>Intelligence Quotient / IQ = <span id="span-iq"></span></li>
            </ul>

            <div><strong>Strengths/Kelebihan:</strong></div>
            <ul class="custom-list" id="list-kelebihan"></ul>

            <div><strong>Weaknesses/Kelemahan:</strong></div>
            <ul class="custom-list" id="list-kelemahan"></ul>

            <div><strong>Recommendation/Rekomendasi:</strong></div>
            <ul class="custom-list" id="list-rekomendasi"></ul>

            <h4 style="text-decoration:underline;">Arah Minat Pendidikan / Pekerjaan</h4>
            <ul class="custom-list" id="list-minat"></ul>
        </div>

        <!-- Tanda Tangan -->
        <div class="signature">
            <p style="text-align:right;"><strong>Medan, <span id="span-tanggal-ttd"></span></strong></p>
            <p style="margin-top:-12px; text-align:right;">Psikolog,</p>
            <div style="text-align:right;"><img src="gambar/ttd.png" alt="Tanda Tangan" style="max-width:20%; height:auto;"/></div>
            <p style="margin-top:-5px; text-align:right;"><strong>Dr. Karina M. Brahmana, M.Psi, Psikolog</strong></p>
            <p style="margin-top:-12px; text-align:right;">No SIPP: 20070136-2021-02-0799</p><br>
            <div class="enter"></div>
            <img class="no-download" src="gambar/medsos.png" alt="Media Sosial" style="max-width:20%; height:auto;"/>
        </div>
    </div>
</div>

<button id="downloadBtn">Download PDF</button>

<!-- Library PDF -->
<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
// =========================================================
// KONFIGURASI API
// Ganti TABLE_NAME sesuai tabel yang digunakan
// =========================================================
const CONFIG = {
    API_URL    : 'https://lidan-co-id.pages.dev/api/contacts_filter_dinamis6',
    TABLE_NAME : 'nilai1',
    API_SECRET : 'admin'
};

// =========================================================
// AMBIL id_x DARI URL
// =========================================================
function getIdFromUrl() {
    return new URLSearchParams(window.location.search).get('id_x');
}

// =========================================================
// FETCH DATA DARI API
// =========================================================
async function fetchData(id) {
    const url = `${CONFIG.API_URL}?table=${CONFIG.TABLE_NAME}&id_x=${id}`;
    const res = await fetch(url, {
        headers: {
            'X-Custom-Auth': CONFIG.API_SECRET,
            'Content-Type': 'application/json'
        }
    });
    if (!res.ok) throw new Error(`HTTP error ${res.status}`);
    const json = await res.json();
    if (!json.success) throw new Error(json.message || 'Data tidak ditemukan');
    return json.data;
}

// =========================================================
// RENDER HALAMAN ‚Äî menggunakan hasil dari PsikogramEngine
// =========================================================
function renderPage(hasil) {
    const { kekuatanKelemahan, minatData, aspekPsikologis } = window.PsikogramEngine;
    const {
        identitas, IQ, resultScores, konsistensi,
        sorted_desc, sorted_asc,
        kelebihan, kelemahan, rekomendasi, minat3
    } = hasil;

    // Identitas
    document.getElementById('td-nama').textContent    = identitas.nama;
    document.getElementById('td-jk').textContent      = identitas.jk;
    document.getElementById('td-usia').textContent    = identitas.usia;
    document.getElementById('td-tanggal').textContent = identitas.tanggal;
    document.getElementById('span-tanggal-ttd').textContent = identitas.tanggalTTD;
    document.getElementById('konsistensi-display').textContent = `Konsistensi = ${konsistensi}`;

    // IQ
    document.getElementById('span-iq').textContent = IQ;

    // Tabel Aspek Psikologis
    const tbody = document.getElementById('tbody-aspek');
    tbody.innerHTML = '';
    aspekPsikologis.forEach(([section, namaAspek, ket], idx) => {
        if (section) {
            const secRow = document.createElement('tr');
            secRow.innerHTML = `<td colspan="12" class="section-header">${section}</td>`;
            tbody.appendChild(secRow);
        }
        const tr = document.createElement('tr');
        let cells = `<td>${namaAspek}</td><td>${ket}</td>`;
        for (let i = 1; i <= 10; i++) {
            const aktif = resultScores[idx] == i;
            cells += `<td class="${aktif ? 'highlight' : ''}" style="width:30px; text-align:center;">${aktif ? '‚úî' : ''}</td>`;
        }
        tr.innerHTML = cells;
        tbody.appendChild(tr);
    });

    // Kelebihan (3 skor tertinggi)
    const listKelebihan = document.getElementById('list-kelebihan');
    listKelebihan.innerHTML = '';
    for (let i = 0; i < 3; i++) {
        const teks = kelebihan[i] !== null
            ? kelebihan[i]
            : kekuatanKelemahan[sorted_desc[i].index].teks2;
        listKelebihan.innerHTML += `<li>${teks}</li>`;
    }

    // Kelemahan (3 skor terendah)
    const listKelemahan = document.getElementById('list-kelemahan');
    listKelemahan.innerHTML = '';
    for (let i = 0; i < 3; i++) {
        const teks = kelemahan[i] !== null
            ? kelemahan[i]
            : kekuatanKelemahan[sorted_asc[i].index].teks3;
        listKelemahan.innerHTML += `<li>${teks}</li>`;
    }

    // Rekomendasi (berdasarkan 3 skor terendah)
    const listRekomendasi = document.getElementById('list-rekomendasi');
    listRekomendasi.innerHTML = '';
    for (let i = 0; i < 3; i++) {
        const teks = rekomendasi[i] !== null
            ? rekomendasi[i]
            : kekuatanKelemahan[sorted_asc[i].index].teks5;
        listRekomendasi.innerHTML += `<li>${teks}</li>`;
    }

    // Minat (3 arah minat terkecil dari RMIB)
    const listMinat = document.getElementById('list-minat');
    listMinat.innerHTML = '';
    minat3.forEach(({ singkatan, namaOverride, ketOverride }) => {
        const item = minatData.find(m => m.singkatan === singkatan);
        if (!item) return;
        const namaMinat = namaOverride ? namaOverride.toUpperCase() : item.arah_minat;
        const ketMinat  = ketOverride  ? ketOverride                : item.keterangan_minat;
        listMinat.innerHTML += `<li><strong>${namaMinat}</strong></li>`;
        listMinat.innerHTML += `<li>Keterangan: ${ketMinat}</li>`;
    });
}

// =========================================================
// DOWNLOAD PDF (identik dengan versi PHP)
// =========================================================
function setupDownload() {
    async function downloadPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        const W = doc.internal.pageSize.getWidth();
        const H = doc.internal.pageSize.getHeight();

        const noDownEls = document.querySelectorAll('.no-download');
        noDownEls.forEach(el => el.style.display = 'none');

        function loadImg(src) {
            return new Promise(resolve => {
                const img = new Image();
                img.onload  = () => resolve(img);
                img.onerror = () => resolve(null);
                img.src = src;
            });
        }

        const [hdr1, ftr1] = await Promise.all([
            loadImg('gambar/01d.jpg'),
            loadImg('gambar/03a1.png')
        ]);

        // Hitung tinggi gambar sesuai rasio asli
        function imgH(img) {
            return (img.naturalHeight * W) / img.naturalWidth;
        }

        // Halaman 1
        const hdr1H = hdr1 ? imgH(hdr1) : 0;
        const ftr1H = ftr1 ? imgH(ftr1) : 0;
        if (hdr1) doc.addImage(hdr1, 'JPEG', 0, 0, W, hdr1H);
        const c1 = await html2canvas(document.getElementById('downloadContent1'), {
            scale: 2,
            useCORS: true,
            allowTaint: true,
            logging: false,
            onclone: (clonedDoc) => {
                // Fix rowspan bug di html2canvas dengan rebuild header tabel
                const thead = clonedDoc.querySelector('thead');
                if (!thead) return;
                thead.innerHTML = `
                    <tr class="header">
                        <th colspan="2" style="background:#f2f2f2;border:1px solid black;padding:8px;text-align:center;font-size:19px;">Aspek dan Deskripsi Psikologis</th>
                        <th colspan="10" style="background:#f2f2f2;border:1px solid black;padding:8px;text-align:center;font-size:19px;">Skala</th>
                    </tr>
                    <tr class="header">
                        <th style="width:250px;background:#f2f2f2;border:1px solid black;padding:8px;text-align:center;font-size:19px;">Aspek Psikologis</th>
                        <th style="width:600px;background:#f2f2f2;border:1px solid black;padding:8px;text-align:center;font-size:19px;">Keterangan</th>
                        <th colspan="4" style="background:#f2f2f2;border:1px solid black;padding:8px;text-align:center;font-size:19px;">K</th>
                        <th colspan="2" style="background:#f2f2f2;border:1px solid black;padding:8px;text-align:center;font-size:19px;">C</th>
                        <th colspan="2" style="background:#f2f2f2;border:1px solid black;padding:8px;text-align:center;font-size:19px;">B</th>
                        <th colspan="2" style="background:#f2f2f2;border:1px solid black;padding:8px;text-align:center;font-size:19px;">BS</th>
                    </tr>`;
            }
        });
        const h1 = (c1.height * W) / c1.width;
        doc.addImage(c1.toDataURL('image/png'), 'PNG', 0, hdr1H, W, h1);
        if (ftr1) doc.addImage(ftr1, 'PNG', 0, H - ftr1H, W, ftr1H);

        // Halaman 2
        doc.addPage();
        const [hdr2, ftr2] = await Promise.all([
            loadImg('gambar/01d.jpg'),
            loadImg('gambar/03a1.png')
        ]);
        const hdr2H = hdr2 ? imgH(hdr2) : 0;
        const ftr2H = ftr2 ? imgH(ftr2) : 0;
        if (hdr2) doc.addImage(hdr2, 'JPEG', 0, 0, W, hdr2H);
        const c2 = await html2canvas(document.getElementById('downloadContent2'), {scale: 2});
        const h2 = (c2.height * W) / c2.width;
        doc.addImage(c2.toDataURL('image/png'), 'PNG', 0, hdr2H, W, h2);
        if (ftr2) doc.addImage(ftr2, 'PNG', 0, H - ftr2H, W, ftr2H);

        doc.save('psikogram.pdf');
        noDownEls.forEach(el => el.style.display = '');
    }

    document.getElementById('downloadBtn').onclick  = downloadPDF;
    document.getElementById('downloadBtn2').onclick = downloadPDF;
}

// =========================================================
// MAIN
// =========================================================
async function main() {
    const id = getIdFromUrl();

    if (!id) {
        document.getElementById('loading-screen').innerHTML = `
            <div style="color:white;font-size:18px;text-align:center;padding:40px;">
                ‚ö†Ô∏è Parameter <code>id_x</code> tidak ditemukan di URL.<br><br>
                Contoh: <code>psikogram.html?id_x=1</code>
            </div>`;
        return;
    }

    try {
        const rawData = await fetchData(id);

        // Semua kalkulasi dikerjakan oleh engine
        const hasil = window.PsikogramEngine.hitungPsikogram(rawData);

        renderPage(hasil);
        document.getElementById('loading-screen').classList.add('hidden');
        setupDownload();

    } catch (err) {
        document.getElementById('loading-screen').innerHTML = `
            <div style="color:white;font-size:18px;text-align:center;padding:40px;">
                ‚ö†Ô∏è Gagal memuat data.<br><br>
                <code style="font-size:14px;">${err.message}</code>
            </div>`;
    }
}

main();
</script>
</body>
</html>